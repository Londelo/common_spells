# Architecture Structure - vf-lib

## Directory Layout

```
vf-lib/
├── package.json              # Root package with dev dependencies for all packages
├── lerna.json                # Lerna monorepo configuration
├── babel.config.json         # Shared Babel config for JavaScript packages
├── tsconfig.json             # Shared TypeScript config for TS packages
├── .gitlab-ci.yml            # CI/CD pipeline configuration
├── packages/                 # Independent npm packages (48 total)
│   ├── access-log/           # Fastly access log formatting
│   ├── apple-music/          # Apple Music API client
│   ├── avro/                 # Avro schema utilities
│   ├── aws/                  # AWS service clients (S3, DynamoDB, Lambda, etc.)
│   ├── batch-fn/             # Batch processing utilities
│   ├── batch-transform-stream/  # Stream batching
│   ├── bitly/                # Bitly URL shortening API client
│   ├── cloudwatch-stdout/    # CloudWatch logging to stdout
│   ├── configs/              # Configuration management
│   ├── crypto/               # Cryptographic utilities (TypeScript)
│   ├── csv-write-stream/     # CSV streaming utilities
│   ├── cucumber-features/    # BDD test features
│   ├── date/                 # Date/time utilities
│   ├── delay/                # Promise delay utilities
│   ├── facebook/             # Facebook API client
│   ├── flatten-transform-stream/  # Stream flattening
│   ├── jwt/                  # JWT token management & worker auth
│   ├── kafka/                # Kafka client
│   ├── locale/               # Locale utilities (TypeScript)
│   ├── log/                  # Winston-based logging
│   ├── map-utils/            # Map/object transformation utilities
│   ├── mongodb/              # MongoDB client utilities
│   ├── normalizers/          # Data normalization utilities
│   ├── object-utils/         # Object manipulation utilities
│   ├── pager-duty/           # PagerDuty integration
│   ├── prometheus/           # Prometheus metrics
│   ├── redis/                # Redis client
│   ├── reduce-lines-from-stream/  # Stream line reduction
│   ├── request/              # HTTP request wrapper with retry logic
│   ├── schemas/              # JSON schemas
│   ├── sfmc/                 # Salesforce Marketing Cloud integration
│   ├── slack/                # Slack API client
│   ├── snowflake/            # Snowflake data warehouse client
│   ├── spotify/              # Spotify API client
│   ├── string-utils/         # String manipulation utilities
│   ├── test-utils/           # Test helpers & Lambda input generators
│   ├── timer/                # Timer utilities
│   ├── titan-request/        # Titan service request client
│   ├── tm-accounts/          # Ticketmaster Accounts API client
│   ├── tm-discovery/         # Ticketmaster Discovery API client
│   ├── tm-orders/            # Ticketmaster Orders API client
│   ├── tm-pacman/            # Ticketmaster PACMAN password service client
│   ├── tm-sms/               # Ticketmaster SMS service client
│   ├── tm-users/             # Ticketmaster Users API client
│   ├── tm-wallet/            # Ticketmaster Wallet API client
│   ├── tracing/              # OpenTelemetry tracing (TypeScript)
│   ├── vf-error/             # Custom error types
│   └── yaml/                 # YAML parsing utilities
└── src/                      # Legacy package sources (for history preservation)
```

## Key Directories

| Directory | Purpose |
|-----------|---------|
| packages/ | Contains 48 independent npm packages, each with its own package.json |
| packages/*/src/ | Source code for each package |
| packages/*/dist/ | Built output (generated by Babel or TypeScript) |
| packages/*/integrationTests/ | Integration tests (separate from unit tests) |
| node_modules/@verifiedfan/ | Symlinked packages (managed by Lerna) |
| src/ | Legacy code preserved for git history |

## Entry Points

Each package has its own entry point defined in its `package.json`:

| Package Type | Entry Point | Build Tool |
|--------------|-------------|------------|
| JavaScript packages | `dist/index.js` | Babel |
| TypeScript packages | `dist/index.js` (compiled from .ts) | TypeScript Compiler |

### Example Entry Points by Package Category

**AWS Services**
- `@verifiedfan/aws` → `packages/aws/src/index.ts`

**Third-Party API Clients**
- `@verifiedfan/spotify` → `packages/spotify/src/index.js`
- `@verifiedfan/apple-music` → `packages/apple-music/src/index.js`
- `@verifiedfan/bitly` → `packages/bitly/src/index.js`
- `@verifiedfan/facebook` → `packages/facebook/src/index.js`

**Ticketmaster Services**
- `@verifiedfan/tm-accounts` → `packages/tm-accounts/src/index.js`
- `@verifiedfan/tm-discovery` → `packages/tm-discovery/src/index.js`
- `@verifiedfan/tm-orders` → `packages/tm-orders/src/index.js`
- `@verifiedfan/tm-users` → `packages/tm-users/src/index.js`
- `@verifiedfan/tm-wallet` → `packages/tm-wallet/src/index.js`
- `@verifiedfan/tm-pacman` → `packages/tm-pacman/src/index.js`
- `@verifiedfan/tm-sms` → `packages/tm-sms/src/index.js`

**Core Utilities**
- `@verifiedfan/jwt` → `packages/jwt/src/index.js`
- `@verifiedfan/tracing` → `packages/tracing/src/index.ts`
- `@verifiedfan/crypto` → `packages/crypto/src/index.ts`
- `@verifiedfan/request` → `packages/request/src/index.js`
- `@verifiedfan/log` → `packages/log/src/index.js`
- `@verifiedfan/test-utils` → `packages/test-utils/src/index.js`

## File Organization Pattern

**Monorepo Structure**: This is a Lerna-managed monorepo containing 48 independent npm packages under the `@verifiedfan` scope.

**Package Organization**:
- Each package is self-contained in `packages/<package-name>/`
- Each package has its own `package.json` with version, dependencies, and build scripts
- Source code lives in `packages/<package-name>/src/`
- Unit tests are co-located with source (`.spec.js` or `.spec.ts` files)
- Integration tests are in separate `integrationTests/` directories
- Built output goes to `packages/<package-name>/dist/`

**Language Mix**:
- **JavaScript (ES6+)**: Most packages use modern JavaScript with Babel
- **TypeScript**: Newer packages (crypto, tracing, locale, aws) use TypeScript

**Package Types**:
1. **API Clients**: Wrappers for third-party services (Spotify, Apple Music, Bitly, Facebook)
2. **TM Service Clients**: Ticketmaster internal service clients (tm-accounts, tm-discovery, tm-orders, etc.)
3. **AWS Utilities**: AWS SDK wrappers (aws package contains S3, DynamoDB, Lambda, SQS, SNS, etc.)
4. **Data Processing**: Stream utilities, batch processing, data transformation
5. **Testing Utilities**: Test helpers, mock data generators, Lambda input builders
6. **Infrastructure**: Logging, tracing, monitoring, error handling
7. **Core Utilities**: JWT, crypto, date handling, string/object manipulation

**Shared Configuration**:
- Root `babel.config.json` shared by all JavaScript packages
- Root `tsconfig.json` extended by TypeScript packages
- Root `package.json` contains all dev dependencies
- Individual packages only declare their runtime dependencies

**Inter-Package Dependencies**:
- Packages can depend on other packages in the monorepo
- Lerna manages symlinks via `node_modules/@verifiedfan/`
- Example: `@verifiedfan/spotify` depends on `@verifiedfan/request` and `@verifiedfan/log`
