# Domain Concepts - reg-ui

## Core Entities

| Entity | Description |
|--------|-------------|
| **Campaign** | A presale registration event for an artist tour, configured with markets, dates, opt-ins, and content. Represents the core business object that fans register for. |
| **Market** | A specific concert event within a campaign, defined by venue, date, city, and timezone. Fans select one or more markets when registering. |
| **Entry** | A fan's registration record for a campaign, containing selected markets, opt-in preferences, presale codes, and modification timestamps. |
| **Fan** | An authenticated end-user with Ticketmaster account, identified by firstName, lastName, email, and location. |
| **Presale Code** | Unique alphanumeric code generated per fan per market, granting access to presale ticket purchases. May be unique or shared depending on market configuration. |
| **Artist** | Musical performer or band associated with campaign, defined by name, image, discovery ID, and optional fan club settings. |
| **Promoter** | Concert promoter organization (e.g., Live Nation, AEG) associated with specific markets, with privacy policies and opt-in requirements. |
| **LinkedCampaign** | Parent campaign that gates access to current campaign, typically a fan club (LNAA) presale that precedes general presale. |
| **Locale** | Language/region configuration (e.g., en-US, fr-CA), determines content language, date formats, and privacy policy links. |
| **Preference** | Opt-in configuration for campaign, defining marketing consents, market selection, and promoter communications. |
| **CampaignGate** | Access control mechanism requiring specific conditions to register: linked campaign entry, invite, or identity verification. |

## Business Rules

### Campaign Lifecycle

- **Draft Status**: Campaign exists but is not publicly accessible; requires `draft=true` query parameter to view
- **Preview Status**: Campaign is accessible via preview URL for testing before public launch
- **Open Status**: Campaign accepts new registrations; fans can register and modify entries
- **Closed Status**: Campaign no longer accepts new registrations or modifications; existing entries remain accessible in read-only mode
- **Campaign Open Window**: Registration only allowed when current time is between `date.open` and `date.close` in campaign's `referenceTimezone`
- **Schema Version Enforcement**: Only campaigns with `schema.version = 2.x` are supported; v1 campaigns return 404
- **Cache TTL**: Campaigns cached in Redis for 1 week; external services responsible for updating cache when campaigns change

### Entry Management

- **One Entry Per Fan Per Campaign**: Each authenticated fan can create exactly one entry per campaign; subsequent submissions update existing entry
- **Entry Modification Window**: Fans can modify entries (markets, opt-ins) only while campaign is open; modifications blocked after campaign closes
- **Entry Persistence**: Entry records persist indefinitely; fans can view confirmation page with presale codes after campaign closes
- **Entry Transfer**: Fans can transfer entry data (markets, opt-ins) from linked campaign to current campaign using `doTransfer` flag
- **Timestamp Tracking**: Entry includes `date.fanModified` timestamp updated on each modification

### Market Selection

- **Minimum Selection**: Fans must select at least one market to submit registration
- **Maximum Selection**: No system limit on number of markets per entry (business may impose via campaign configuration)
- **Market Availability**: Only markets in `OPEN` or `PREVIEW` status are selectable
- **Added Shows**: Markets can be marked `isAddedShow` to distinguish from original tour announcement
- **Market Timezone**: Each market has own timezone for event date display; presale times use market timezone

### Presale Code Generation

- **Unique Codes**: By default, each fan receives unique presale code per selected market
- **Shared Codes**: Markets can configure `sharedCode` to use single code for all fans (e.g., radio promotion codes)
- **Code Stability**: Presale codes persist across entry modifications; new codes only generated for newly added markets
- **Code Format**: Codes are alphanumeric strings generated by backend (format varies by campaign configuration)
- **Code Visibility**: Codes displayed on confirmation page and in confirmation email; accessible anytime fan returns to campaign

### Opt-In Preferences

- **Required Opt-Ins**: Preferences with `is_optional: false` must be checked to submit form
- **Optional Opt-Ins**: Preferences with `is_optional: true` are pre-checked by default but can be unchecked
- **Default States**: Artist marketing defaults to `true`, Live Nation marketing defaults to `true`, artist SMS defaults to `false`
- **Promoter Opt-Ins**: Dynamically generated based on selected markets' associated promoters; hidden if no markets selected
- **Privacy Policy Links**: Each opt-in displays privacy policy link resolved to user's locale
- **Consent Capture**: All opt-in states persisted with entry record for compliance and marketing segmentation

### Campaign Gates (Access Control)

- **Linked Campaign Gate**: Requires fan to have entry in specified parent campaign (e.g., LNAA presale) before accessing child campaign
- **Invite-Only Gate**: Requires fan to have valid invite token (query parameter or backend validation)
- **Identity Verification (IDV) Gate**: Requires fan to complete facial recognition/liveness check before registration enabled
- **No Gate**: Campaign is publicly accessible to all authenticated fans
- **Gate Enforcement**: Gates validated on both server (page load) and client (form submission) for security

### LNAA (Fan Club) Integration

- **LNAA Campaign Designation**: Campaigns with `options.isLNAA = true` are fan club presale campaigns
- **Membership States**: Fan can be non-member, active member, or dormant member
- **Activation Opt-In**: Dormant members see opt-in to activate membership during registration
- **Auto-Grant**: Active members automatically see member badge, no opt-in needed
- **Linked Campaign Priority**: LNAA entries typically grant access to linked general presale campaigns

### Locale and Internationalization

- **Locale Resolution**: System determines best viewing locale from campaign's supported locales and user's browser `Accept-Language` header
- **Locale Fallback**: Missing translations fall back to default locale (en-US) using `@verifiedfan/locale` package
- **Content Transformation**: Campaign content (FAQs, landing text, confirmation text) transformed to target locale on server before rendering
- **URL Localization**: Privacy policies, terms of use, ticketing links resolve to locale-specific versions when available
- **Date Formatting**: Dates formatted according to locale conventions (e.g., MM/DD/YYYY in US, DD/MM/YYYY in UK)

### Timezone Handling

- **Reference Timezone**: Campaign has single `referenceTimezone` (IANA timezone identifier) for open/close times
- **Market Timezones**: Each market has own timezone for event date display
- **Validation**: Invalid timezones auto-corrected to valid IANA identifiers on load
- **Display**: All dates/times displayed to fan in appropriate timezone with timezone abbreviation (e.g., PST, EST)

### Split Allocation

- **Concurrent Split**: Multiple presale allocations available simultaneously; fan gets code for one allocation, linked to other allocation
- **Sequential Split**: Multiple presale allocations available in sequence; fan gets code for first allocation, instructions for second if first unsuccessful
- **Split Visibility**: Markets with split allocation display badge and explanation on confirmation page
- **Link Provision**: Confirmation page provides links to all allocation sources (Ticketmaster, venue site, etc.)

## Terminology

| Term | Definition |
|------|------------|
| **Verified Fan** | Ticketmaster's presale access program requiring fan registration to combat bots and scalpers. |
| **Presale** | Limited-time ticket sale period before general public on-sale, restricted to fans with presale codes. |
| **Presale Code** | Unique alphanumeric code granting access to presale ticket purchase. |
| **Campaign Slug** | URL-friendly identifier for campaign (e.g., `taylor-swift-eras-tour`), used in URL path. |
| **Entry** | A fan's registration record for a specific campaign. |
| **Market** | A specific concert event within a tour (venue + date). |
| **LNAA (Live Nation Artist Alliance)** | Live Nation's fan club platform offering membership benefits including priority presale access. |
| **Linked Campaign** | Parent campaign that controls access to child campaign (typically fan club presale linked to general presale). |
| **IDV (Identity Verification)** | Facial recognition and liveness detection process to verify fan identity for high-demand campaigns. |
| **Opt-In** | Marketing consent preference allowing artist, Live Nation, or promoters to contact fan. |
| **General On-Sale** | Public ticket sale period after presale ends, no presale code required. |
| **Presale Window** | Time period when presale is active (`date.presaleWindowStart` to `date.presaleWindowEnd`). |
| **Campaign Gate** | Access control mechanism requiring specific conditions before fan can register. |
| **Added Show** | Concert date added to tour after initial announcement. |
| **Split Allocation** | Ticket inventory divided across multiple presale sources or time periods. |
| **Draft Campaign** | Campaign in development, not publicly accessible without preview token. |
| **Confirmation Page** | Post-registration view showing selected markets, presale codes, and next steps. |
| **Registration Page** | Initial campaign view with market selection and opt-in form. |
| **Campaign Cache** | Redis storage layer holding campaign configurations with 1-week TTL. |
| **AppSync** | AWS GraphQL service providing backend API for entries, fan data, and LNAA operations. |
| **Promoter** | Concert promoter organization (Live Nation, AEG, etc.) with specific marketing opt-ins. |
| **Locale** | Language/region code (e.g., en-US, fr-CA) determining content language and format. |
| **Reference Timezone** | Primary timezone for campaign's open/close times. |
| **Market Timezone** | Timezone for specific concert event date. |
| **Entry Transfer** | Copying market selections and opt-ins from linked campaign to current campaign. |
| **Countdown Timer** | UI component showing time remaining until campaign opens or closes. |
| **Hero Image** | Large banner image at top of campaign page, often featuring artist. |
| **FAQ** | Frequently Asked Questions section with campaign-specific Q&A. |
| **Timeline** | Visual representation of registration → presale → general on-sale milestones. |
| **Ticketing Link** | URL to presale ticket purchase page on Ticketmaster or venue site. |
| **Surrogate Key** | CDN cache identifier for campaign, used for cache purging on updates. |
| **Queue-it** | Virtual waiting room service for high-traffic campaigns. |
| **NuData** | Fraud detection service integrated for security. |

## Data Models

### Campaign (Primary Entity)

```typescript
Campaign {
  id: string                      // Unique campaign identifier (UUID)
  type: 'presaleSignUp'           // Campaign type (always presaleSignUp for reg-ui)
  slug: string                    // URL-friendly identifier (e.g., 'artist-tour-2024')
  status: CampaignStatus          // DRAFT | OPEN | CLOSED | PREVIEW

  domain: {
    site: string                  // Campaign domain (e.g., 'verifiedfan.ticketmaster.com')
    preview?: string              // Preview domain for draft campaigns
  }

  artist: {
    id: string                    // Artist UUID
    discovery_id: string          // Artist ID in discovery system
    name: string                  // Artist display name
    image_url: string             // Artist profile image URL
    adpUrl?: string               // Artist detail page URL
    fanclubName?: string          // Fan club name if LNAA
    detail?: {                    // Enriched artist data from discovery service
      externalLinks: {            // Social media links
        [platform]: { url }
      }
      images: Image[]             // Artist images in various ratios
    }
  }

  tour: {
    name: string                  // Tour name (e.g., 'Eras Tour')
  }

  schema: {
    version: string               // Schema version (must be '2.x')
  }

  date: {
    created: string               // ISO 8601 timestamp
    updated: string               // ISO 8601 timestamp
    open: string                  // Registration open time (ISO 8601)
    opened?: string               // Actual opened time (if manually opened)
    close: string                 // Registration close time (ISO 8601)
    closed?: string               // Actual closed time (if manually closed)
    presaleWindowStart: string    // Presale begins (ISO 8601)
    presaleWindowEnd: string      // Presale ends (ISO 8601)
    generalOnsale?: string        // General on-sale time (ISO 8601)
  }

  referenceTimezone: string       // IANA timezone (e.g., 'America/New_York')

  locales: [                      // Supported locales
    {
      id: string                  // Locale code (e.g., 'en-US')
      is_default: boolean         // Default locale flag
    }
  ]

  markets: [                      // Concert events
    {
      id: string                  // Market UUID
      campaign_id: string         // Parent campaign ID
      name: string                // Market display name
      city: string                // City name
      state: string               // State/province code
      timezone: string            // IANA timezone for event
      isAddedShow?: boolean       // Added after initial announcement
      promoterIds: string[]       // Associated promoter UUIDs
      point: {                    // Geographic coordinates
        coordinates: [lng, lat]
      }
      event: {
        date: string              // Event date (ISO 8601)
        presaleDateTime: string   // Presale start time (ISO 8601)
        ids: string[]             // Event IDs from ticketing systems
        link: string              // Ticketing URL
        ticketer: string          // Ticketing platform (e.g., 'TM', 'AXS')
        venue: {
          name: string            // Venue name
        }
        sharedCode?: string       // Shared presale code (if not unique)
        splitAllocation?: {       // Split allocation config
          type: 'concurrent' | 'sequential'
          isActive: boolean
          link?: string           // Alternate allocation URL
        }
      }
      date: {
        created: string           // ISO 8601 timestamp
        updated: string           // ISO 8601 timestamp
      }
    }
  ]

  preferences: [                  // Opt-in configurations
    {
      id: string                  // Preference ID (e.g., 'allow_marketing')
      type: 'opt_in' | 'markets'  // Preference type
      is_optional: boolean        // Required vs optional
      label: {                    // Localized labels
        'en-US': string
        [locale]: string
      }
      additional: {
        max_length?: number       // For text inputs
      }
    }
  ]

  options: {
    gate: {                       // Access control
      linkedCampaign?: string     // Parent campaign ID
      inviteOnly?: string         // Invite requirement
      idv?: string                // IDV requirement
    }
    isLNAA?: boolean              // LNAA fan club flag
  }

  content: {                      // Localized content
    'en-US': {
      faqs: {                     // FAQ entries
        [key]: {
          question: string
          answer: string          // HTML/Markdown
        }
      }
      landing: object             // Landing page content
      confirmation: object        // Confirmation page content
      email: object               // Email template content
    }
    [locale]: { ... }             // Other locales
  }

  faqs: {                         // FAQ display config
    landing: {
      open: string[]              // FAQ keys shown open on landing
      closed: string[]            // FAQ keys shown closed on landing
    }
    confirmation: {
      open: string[]              // FAQ keys shown open on confirmation
      closed: string[]            // FAQ keys shown closed on confirmation
      activePresale: string[]     // FAQ keys shown during active presale
    }
  }

  style: {                        // Theming/branding
    theme: {
      primary: string             // Primary brand color (hex)
      mix70: string               // 70% mix with white
      mix40: string               // 40% mix with white
      mix30: string               // 30% mix with white
      mix20: string               // 20% mix with white
    }
    border: {
      primary: string             // Border color
    }
    pageBackground: {
      primary: string             // Page background color
    }
    text: {
      primary: string             // Primary text color
      secondary: string           // Secondary text color
    }
    checkbox: {                   // Checkbox styling
      default: { fill, border }
      hover: { fill }
      active: { fill }
      checked: { fill }
      checkedHover: { fill }
      disabled: { fill, border }
    }
  }

  image: {                        // Campaign images
    main: { url: string }         // Desktop hero image
    mobile?: { url: string }      // Mobile hero image
    secondary: { url: string }    // Secondary/background image
  }

  subType?: 'fanclub'             // Campaign subtype

  promoters?: {                   // Enriched promoter data
    [promoterId]: {
      id: string
      name: string
      privacyUrls: [
        {
          url: string
          locale: string
          is_default: boolean
        }
      ]
    }
  }
}
```

### Entry (Fan Registration Record)

```typescript
Entry {
  campaignId: string              // Campaign ID (UUID)
  locale: string                  // Locale used during registration (e.g., 'en-US')

  fields: {                       // Form field values (JSON)
    markets: string[]             // Selected market IDs
    allow_marketing: boolean      // Artist marketing opt-in
    allow_livenation: boolean     // Live Nation marketing opt-in
    allow_artist_sms: boolean     // Artist SMS opt-in
    promoterOptIns?: string[]     // Promoter opt-in IDs
    lnaaOptIn?: boolean           // LNAA activation opt-in
  }

  attributes: {                   // Entry metadata (JSON)
    doTransfer?: boolean          // Entry transferred from linked campaign
    [custom]: any                 // Campaign-specific attributes
  }

  codes: [                        // Generated presale codes
    {
      id: string                  // Presale code string
      marketId: string            // Associated market ID
    }
  ]

  date: {
    fanModified: string           // Last modification timestamp (ISO 8601)
  }
}
```

### Fan (User Profile)

```typescript
Fan {
  firstName: string               // Fan first name
  lastName: string                // Fan last name
  email: string                   // Fan email address
  isLoggedIn: boolean             // Authentication status

  location?: {                    // Geographic location
    latitude: number              // Decimal degrees
    longitude: number             // Decimal degrees
  }
}
```

### Client State (Zustand Store)

```typescript
Store {
  campaign: Campaign              // Current campaign data
  linkedCampaign: LinkedCampaign | null  // Parent campaign if gated

  user: {
    isLoggedIn: boolean           // Authentication state
    hasEntry: boolean             // Entry exists for campaign
    isLNAAMember: boolean         // LNAA membership status
    name: string | null           // Fan full name
    email: string | null          // Fan email
    codeByMarket: Map<string, string>  // Market ID → presale code
    doTransfer?: boolean          // Entry transfer flag
    location: {                   // Fan location
      latitude: number
      longitude: number
    } | null
    entryDate?: {
      fanModified: string         // Entry modification timestamp
    }
  }

  form: {
    markets: string[]             // Selected market IDs
    allow_marketing: boolean      // Artist marketing opt-in
    allow_livenation: boolean     // Live Nation opt-in
    allow_artist_sms: boolean     // Artist SMS opt-in
    promoterOptIns?: string[]     // Promoter opt-in IDs
    lnaaOptIn: boolean            // LNAA opt-in
  }

  ui: {
    page: 'registration' | 'confirmation'  // Current page
    modal: {                      // Active modal
      type: 'error' | 'termsOfUse'
      modalProps?: {
        code?: string             // Error code
      }
    } | null
    locale: string                // Active locale
    isSubmitting: boolean         // Form submission state
    isStoreLoaded: boolean        // Store hydration complete
    scrollTo: string | null       // Element to scroll to
    isMobileApp: boolean          // Mobile app context
  }
}
```

### Relationships

```
Campaign (1) ─── (0..1) LinkedCampaign
    │
    ├── (1..N) Markets
    │       │
    │       └── (0..N) Promoters
    │
    ├── (1..N) Locales
    │
    ├── (1..N) Preferences
    │
    └── (1) Artist
            │
            └── (0..1) ArtistDetail

Fan (1) ─── (0..N) Entries
    │
    Entry (1) ─── (1) Campaign
        │
        ├── (1..N) Codes
        │       │
        │       └── (1) Market
        │
        └── (0..N) Opt-In Selections
```

### Data Flow Summary

1. **Campaign Service** → Redis Cache: Campaign configuration data cached with 1-week TTL
2. **Redis Cache** → reg-ui: Campaign data retrieved on page request by slug
3. **reg-ui** → AppSync: Fan entry mutations (create/update) and queries (getEntry, getLNAAMemberStatus)
4. **AppSync** → Database: Entry records persisted with codes and opt-ins
5. **reg-ui** → Client Store: Campaign and entry data hydrated into Zustand state
6. **Client Store** → UI Components: State consumed by React components for rendering
7. **User Actions** → Client Store: Form interactions update state
8. **Client Store** → AppSync: Form submission triggers GraphQL mutations
9. **AppSync Response** → Client Store: Entry record with codes updates user state
10. **Client Store** → UI: Page transition to confirmation, codes displayed
