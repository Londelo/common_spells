# Domain Concepts - campaign-workers

## Core Entities

| Entity | Description |
|--------|-------------|
| **Campaign** | A Verified Fan campaign with configuration (markets, dates, options) that fans register for |
| **Fan / Registrant** | A user who registered for a campaign, represented by globalUserId, memberId, email, phone |
| **Score** | A numerical value (0-1) representing fan eligibility quality, assigned by scoring algorithms |
| **Band Score** | A randomized score within a quality tier (high/mid/low) to introduce fairness |
| **Code / Access Code** | A unique alphanumeric string that grants campaign access, generated by TM or external partners |
| **Wave** | A batch of fans scheduled to receive notifications at a specific notify date/time |
| **Market** | A geographic or logical grouping with capacity limits (e.g., "US", "UK", "VIP") |
| **Selection** | The set of fans chosen for a campaign based on scores, capacity, and eligibility rules |
| **Code Assignment** | The binding of a specific access code to a specific fan for a specific campaign |
| **Blacklist** | A list of email addresses or domains that are automatically disqualified from campaigns |
| **Tag** | A label applied to fan records indicating data quality issues (e.g., "unconfirmed_phone") |
| **Record Type** | Category of campaign data (e.g., "registration", "codeAssignment") with associated Avro schema |
| **Avro File** | Schema-validated binary file format used for campaign data storage in data lake |
| **Merged File** | Consolidated Avro file combining multiple source files for query efficiency |
| **Wave Config** | JSON configuration defining wave parameters (notifyDate, productId, source, options) |
| **Wave File** | CSV file containing fan records for a wave, with columns like code, email, phone, marketId |
| **Dedupe Info** | Hash-based unique identifier added to records to prevent duplicate processing |

## Business Rules

### Scoring & Eligibility Rules
- **Band Score Randomization**: Fans with raw scores in the same tier receive randomized band scores to prevent unfair advantage
  - High band: 0.95-1.0 for raw scores ≥0.95
  - Mid band: 0.80-0.95 for raw scores 0.80-0.95
  - Low band: 0.22-0.80 for raw scores 0.22-0.80
- **Blacklist Absolute**: Email addresses on blacklist are automatically disqualified regardless of score
- **Whitelist Priority**: Email patterns matching whitelist bypass blacklist rules
- **International Phone Gating**: International phone numbers rejected unless campaign explicitly enables `allowIntlPhones`
- **Unconfirmed Phone Tagging**: Phones without verification are tagged but may still be eligible based on campaign rules

### Code Management Rules
- **Code Uniqueness**: Each code generated is globally unique across all campaigns
- **Code Validity Window**: Codes are valid from 1 day before notify date to 1 year after (handles timezone edge cases)
- **TM Code Placeholder**: Code value "TM" indicates TM-managed inventory, not published to streams
- **Single Assignment**: Each fan receives exactly one code per campaign; duplicate assignments prevented
- **External Code Reservation**: Partner codes (via Pacman) reserved in batches before assignment to prevent race conditions
- **Code Immutability**: Once assigned, code-to-fan binding cannot be changed

### Wave Processing Rules
- **Notify Date Anchor**: All wave timing based on configured `notifyDate` in ISO 8601 format
- **Market Capacity Enforcement**: Fan selection per market cannot exceed configured capacity limit
- **Selection Time Windows**: Fans selected based on market-specific selection time configuration
- **Wave Retry Limit**: Wave preparation limited to 2 attempts; 3rd failure requires manual intervention
- **File Categorization**: Wave output files organized by delivery channel (email, sms, masterCodes)
- **Status Tracking**: Each wave attempt tracked in status JSON with timestamps, counts, error details

### Data Consolidation Rules
- **Daily Merge**: Campaign data consolidated daily at midnight for previous day's data
- **Monthly Merge**: Month's data consolidated into single file on 1st of next month
- **Schema Validation**: Only current schema versions allowed; outdated schemas rejected
- **Size Limit**: Merged files exceeding 1.2GB rejected to prevent Athena query timeouts
- **Record Type Isolation**: Merge operates per record type (registration, codeAssignment, etc.) independently
- **Archive Before Replace**: Source files copied to /merged/ prefix before deletion

### Notification Delivery Rules
- **Concurrency Limit**: SMS notifications sent in batches of 200 concurrent requests to respect rate limits
- **Multi-Channel Attempt**: Both SMS and email attempted if fan has both contact methods
- **Failure Tolerance**: Failed notifications tracked but don't block wave completion
- **Template Metadata**: All notifications include campaign name, wave date, and access code
- **Email Queueing**: Email notifications queued to SQS for async processing by Salesforce Marketing Cloud

### Data Quality Rules
- **Trimming**: All string fields trimmed of leading/trailing whitespace before storage
- **Schema Validation**: All records validated against Avro schema before writing to data lake
- **Dedupe Hashing**: Unique hash generated for each record based on key fields to prevent duplicates
- **Phone Validation**: Phone numbers validated for format and country code before notification attempt
- **Email Domain Validation**: Email domains checked against patterns for disposable/fraudulent services

## Terminology

| Term | Definition |
|------|------------|
| **Verified Fan** | Ticketmaster's fan verification program for fair ticket access |
| **Campaign Pipeline** | The automated workflow processing fans from registration to notification |
| **Scoring Bucket** | S3 bucket storing scored fan files, wave configs, and wave CSVs |
| **Campaign Data Bucket** | S3 bucket serving as data lake for Avro campaign records |
| **Input Stream** | Kinesis stream receiving code assignment records |
| **Save Selection Stream** | Kinesis stream receiving scored and validated fan records |
| **Scrubbed File** | Cleaned CSV output after validation, stored for audit purposes |
| **Fan Score / Fanscore** | Algorithmic score (0-1) indicating fan authenticity and engagement |
| **Raw Local Fanscore** | Original score from scoring algorithm before band randomization |
| **Pacman** | TM code management service for generating and tracking access codes |
| **Global User ID** | TM's global user identifier across all systems |
| **Member ID** | TM's user identifier within a specific brand/context |
| **Category ID** | Optional identifier for campaign subcategory or variant |
| **Market ID** | Identifier for geographic or logical market segment |
| **Notify Date** | ISO 8601 timestamp when wave notifications should be sent |
| **Begin Date** | Code validity start date (notify date - 1 day) |
| **End Date** | Code validity end date (notify date + 1 year) |
| **Wave File Prefix** | Unique identifier for wave files (e.g., `{campaignId}_{dateKey}`) |
| **Date Key** | Date-based identifier in format YYYYMMDD used for wave organization |
| **Triggered State** | Wave config state indicating code assignments published to stream |
| **Completed State** | Wave config state indicating notifications sent successfully |
| **Athena Query ID** | UUID identifying Athena query execution used as temporary file reference |
| **Record Dedupe Hash** | SHA-256 hash of key fields used to detect duplicate records |
| **Tag** | Label indicating data quality issue (e.g., `unconfirmed_phone`, `intl_phone`) |
| **Correlation ID** | UUID tracking request flow across workers and services |
| **Batch Size** | Number of records processed in a single batch (typically 2500) |
| **Concurrency** | Number of parallel operations (e.g., 200 SMS/sec) |

## Data Models

### Campaign Data Record (Kinesis/Avro)
```javascript
{
  type: 'registration',           // Record type
  date: {
    created: '2024-01-15T10:30:00Z'  // ISO 8601 timestamp
  },
  campaignId: '12345',
  globalUserId: 'abc-123',
  memberId: 'mem-456',              // Optional
  marketId: 'us-west',              // Optional
  email: 'fan@example.com',
  phone: '+12065551234',
  score: 0.92,                      // Raw fanscore
  band_score: 0.97,                 // Randomized within band
  tags: ['unconfirmed_phone'],      // Data quality tags
  dedupeHash: 'sha256...'           // Unique hash
}
```

### Code Assignment Record (Kinesis)
```javascript
{
  type: 'codeAssignment',
  date: {
    created: '2024-01-15T10:30:00Z'
  },
  campaignId: '12345',
  categoryId: '67890',              // Optional
  globalUserId: 'abc-123',
  memberId: 'mem-456',              // Optional
  marketId: 'us-west',              // Optional
  code: 'ABC123XYZ',
  dedupeHash: 'sha256...'
}
```

### Wave Config
```javascript
{
  campaignId: '12345',
  categoryId: '67890',              // Optional
  notifyDate: '2024-01-20T18:00:00Z',
  beginDate: '2024-01-19T18:00:00Z',  // Auto-calculated
  endDate: '2025-01-20T18:00:00Z',    // Auto-calculated
  productId: 'PROD-456',
  source: 'SFMC',
  generateOfferCode: true,
  options: {
    allowIntlPhones: false,
    customField: 'value'
  }
}
```

### Market Details
```javascript
{
  marketId: 'us-west',
  marketName: 'US West',
  capacity: 5000,                   // Max fans for this market
  selectionTime: '2024-01-18T12:00:00Z'  // When to select fans
}
```

### Wave Status
```javascript
{
  date: {
    started: '2024-01-18T10:00:00Z',
    finished: '2024-01-18T10:15:00Z'  // Optional
  },
  status: 'FINISHED',               // TRIGGERED | FINISHED | FAILED
  attempts: 1,
  path: 's3://bucket/key',          // Output file path
  count: {
    email: 4500,
    sms: 4200,
    masterCodes: 5000
  },
  error: {                          // Optional
    message: 'Code service timeout',
    developer_message: 'HTTP 504'
  }
}
```

### Scored File Format (TSV Input)
```
id	tmemail	sms	global_user_id	member_id	raw_local_fanscore	country_code
123	fan@example.com	2065551234	abc-123	mem-456	0.92	US
```

### Wave File Format (CSV)
```csv
globalUserId,memberId,marketId,email,phone,code
abc-123,mem-456,us-west,fan@example.com,+12065551234,ABC123XYZ
```

### Scrubbed File Format (CSV Output)
```csv
id,email,phone,globalUserId,memberId,score,band_score,tags,marketId
123,fan@example.com,+12065551234,abc-123,mem-456,0.92,0.97,"unconfirmed_phone",us-west
```

### Merge Statistics
```javascript
{
  filePrefix: 'registration/2024/01/15',
  mergedFileKey: 'campaignData/registration/merged/registration_2024_01_15.avro',
  count: {
    records: 125000,                // Records merged
    files: 48                       // Source files consolidated
  }
}
```

### Notification Result
```javascript
{
  total: 5000,
  ok: 4950,
  failed: 50,
  detail: {
    sms: {
      sent: 4700,
      failed: 300
    },
    email: {
      sent: 4950,
      failed: 50
    }
  }
}
```

## Domain Relationships

```
Campaign (1) ----< (N) Wave
Wave (1) ----< (N) Fan/Registrant
Fan (1) ----< (1) Score
Fan (1) ----< (1) Code Assignment
Market (1) ----< (N) Fan
Campaign (1) ----< (N) Market
Code (1) ----< (1) Code Assignment
Wave (1) ----< (1) Wave Config
Wave (1) ----< (N) Notification (SMS/Email)
```

## State Transitions

### Wave Lifecycle
```
CONFIGURED → (generateCodes) → CODE_GENERATED → (prepareWave) → PREPARED →
(triggerWave) → TRIGGERED → (sendNotifications) → COMPLETED
```

### File States
```
UPLOADED → PROCESSING → VALIDATED → STREAMED → SAVED
```

### Merge States
```
FRAGMENTED → QUERYING → CONSOLIDATING → MERGED → ARCHIVED
```

## Key Patterns

### Score Banding Algorithm
```javascript
// Input: raw_local_fanscore = 0.92
// Band determination: 0.92 falls in [0.80, 0.95] = mid band
// Random generation: random value in [0.80, 0.95) = 0.87
// Output: band_score = 0.87
```

### Code Validity Window
```javascript
// Input: notifyDate = 2024-01-20T18:00:00Z
// Calculation:
//   beginDate = notifyDate - 1 day = 2024-01-19T18:00:00Z
//   endDate = notifyDate + 1 year = 2025-01-20T18:00:00Z
// Purpose: Handle timezone edge cases and redemption window
```

### Partition Key Strategy
```javascript
// Code assignments partitioned by code for ordering
// Scored records partitioned by globalUserId for fan-based queries
// Ensures related records land in same shard for consistency
```

### Batch Processing Pattern
```javascript
// Input: 125,000 records
// Batch size: 2,500 records
// Batches: 50 batches
// Processing: Parallel API calls per batch
// Aggregation: Sum results from all batches
// Purpose: Balance throughput vs. API rate limits
```

### Retry Strategy
```javascript
// Max attempts: 2 per wave
// Tracking: status JSON records attempt count
// Idempotency: Operations safe to retry (code reservation, assignment)
// Failure mode: 3rd attempt blocked, requires manual intervention
// Purpose: Recover from transient failures without infinite loops
```
